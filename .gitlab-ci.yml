# MigFlow - Copyright (C) <2010-2018>
# <Universite catholique de Louvain (UCL), Belgium
#  Universite de Montpellier, France>
# 	
# List of the contributors to the development of MigFlow: see AUTHORS file.
# Description and complete License: see LICENSE file.
# 	
# This program (MigFlow) is free software: 
# you can redistribute it and/or modify it under the terms of the GNU Lesser General 
# Public License as published by the Free Software Foundation, either version
# 3 of the License, or (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
# 
# You should have received a copy of the GNU Lesser General Public License
# along with this program (see COPYING and COPYING.LESSER files).  If not, 
# see <http://www.gnu.org/licenses/>.

mseabuild-linux :
  image : immc/msea-build:v0.1
  stage : build
  script:
    - cd msealib
    - mkdir build
    - cd build/
    - cmake .. -DCMAKE_BUILD_TYPE=Release
    - make
    - cp libmsea.so ../../msea
    - cd ../..
    - python3 setup.py bdist_wheel --plat-name=manylinux1_x86_64
  artifacts:
    paths:
      - dist
    expire_in: 1 day

mseabuild-windows :
  image : immc/msea-build:v0.1
  stage : build
  script:
    - cd msealib
    - mkdir build-mingw
    - cd build-mingw
    - cmake .. -DCMAKE_TOOLCHAIN_FILE=/cmake-mingw -DCMAKE_BUILD_TYPE=Release
    - make
    - mv *.dll *.dll.a ../../msea
    - cd ../..
    - python3 setup.py bdist_wheel --plat-name=win_amd64 

mseabuild-osx :
  image : immc/msea-build:v0.1
  stage : build
  script:
    - cd msealib
    - mkdir build-osxcross
    - cd build-osxcross
    - $(osxcross-conf) && cmake .. -DCMAKE_TOOLCHAIN_FILE=/osxcross/target/toolchain.cmake -DCMAKE_BUILD_TYPE=Release
    - make
    - mv *.dylib ../../msea
    - cd ../../
    - python3 setup.py bdist_wheel --plat-name=macosx_10_9_x86_64
  artifacts:
    paths:
      - dist
    expire_in: 1 day

mseatest :
  image : immc/msea-valid:v0.1
  stage : test
  script:
    - pip3 install --user --upgrade --user --no-cache-dir dist/*manylinux1_x86_64*
    - cd tests
    - python3 testshp.py 

mfdeploy-test :
  image : immc/msea-build:v0.1
  stage : deploy
  rules :
    - if: '$CI_COMMIT_TAG =~ /^w-.*$/'
      when: always
  script:
    - twine upload --repository testpypi dist/* 


mfdeploy :
  image : immc/msea-build:v0.1
  stage : deploy
  rules :
    - if: '$CI_COMMIT_TAG =~ /^v-.*$/'
      when: always
  script:
    - twine upload dist/* 
